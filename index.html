<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Goal Reporting with Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #goal-form, #password-section, #punishment-section, #admin-section { margin-top: 20px; }
        #reporting-section, #punishment-section, #admin-section { display: none; }
        .goal-status, .punishment-status { margin: 10px; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .fail { color: red; }
        .item-container { margin-bottom: 15px; }
        .item-container input { margin-right: 10px; }
    </style>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

    <!-- Password Section -->
    <div id="password-section">
        <p>Enter your unique passcode:</p>
        <input type="password" id="password" placeholder="Passcode">
        <button onclick="checkPassword()">Submit</button>
    </div>

    <!-- Reporting Section -->
    <div id="reporting-section">
        <h2>Anonymous Goal Reporting</h2>
        <h3>Current Goals</h3>
        <div id="goals-list"></div>

        <!-- Reporting Form -->
        <div id="goal-form">
            <p>Did you fail any goals this week?</p>
            <input type="checkbox" id="failed-goal"> Failed a goal<br>
            <button onclick="submitGoalReport()">Submit Report</button>
        </div>

        <h3>This Week's Report</h3>
        <div id="status-display">
            <p><strong>Time since last failed:</strong> <span id="time-since-fail">N/A</span></p>
            <p><strong>Amount of times failed this week:</strong> <span id="fail-count">0</span></p>
        </div>

        <!-- Punishment Section -->
        <div id="punishment-section">
            <h3>Weekly Punishment Assignment</h3>
            <div id="punishment-info">
                <p><strong>Your Assigned User:</strong> <span id="assigned-user"></span></p>
                <p><strong>Your Assigned Punishment:</strong> <span id="assigned-punishment"></span></p>
            </div>
            <div id="punishment-form">
                <textarea id="punishment-text" placeholder="Enter punishment..."></textarea><br>
                <button onclick="submitPunishment()">Submit Punishment</button>
            </div>
            <div id="voting-section">
                <h4>Vote if the punishment is unfair</h4>
                <button onclick="voteUnfair()">Vote Unfair</button>
            </div>
        </div>

        <!-- Change Password Section -->
        <div id="change-password-section">
            <h3>Change Password</h3>
            <input type="password" id="new-password" placeholder="New Password">
            <button onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section">
        <h2>Admin: Manage Users and Goals</h2>

        <!-- User Management -->
        <div>
            <h3>Users</h3>
            <div id="user-container"></div>
            <button onclick="addUserInput()">Add User</button>
            <button onclick="resetWeeklyFails()">Clear This Week's Fails</button>
            <button onclick="randomizePunishmentAssignments()">Randomize Punishment Assignments</button>
        </div>

        <!-- Goal Management -->
        <div>
            <h3>Goals</h3>
            <div id="goal-container"></div>
            <button onclick="addGoalInput()">Add Goal</button>
        </div>

        <button onclick="submitAdminData()">Submit Data</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXH3CI4YN4fRDH1Wcp_PQQCGBvpp8Dep8",
            authDomain: "goal-storing.firebaseapp.com",
            projectId: "goal-storing",
            storageBucket: "goal-storing.appspot.com",
            messagingSenderId: "1041018123354",
            appId: "1:1041018123354:web:497f0baf04deb124ccd463",
            measurementId: "G-1FPM1DV7KH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const adminCode = "admincode"; // Set your admin code here
        let currentUser;

        // Check if entered password is admin or user passcode
        async function checkPassword() {
            const inputPass = document.getElementById("password").value.trim();
            if (inputPass === adminCode) {
                document.getElementById("password-section").style.display = "none";
                document.getElementById("admin-section").style.display = "block";
                loadAdminData();
            } else {
                const userDoc = await db.collection("users").where("password", "==", inputPass).get();
                if (!userDoc.empty) {
                    currentUser = userDoc.docs[0].id;
                    document.getElementById("password-section").style.display = "none";
                    document.getElementById("reporting-section").style.display = "block";
                    loadGoals();
                    loadPunishmentAssignment();
                    loadWeeklyReport();
                } else {
                    alert("Incorrect passcode.");
                }
            }
        }

        // Load goals for the current user
        async function loadGoals() {
            const goalsList = document.getElementById("goals-list");
            goalsList.innerHTML = "";
            const goalsSnapshot = await db.collection("goals").where("userId", "==", currentUser).get();
            goalsSnapshot.forEach((doc) => {
                const goal = doc.data();
                const goalElem = document.createElement("div");
                goalElem.classList.add("goal-status");
                goalElem.innerHTML = `Goal: ${goal.text}`;
                goalsList.appendChild(goalElem);
            });
        }
        async function loadPunishmentVotes() {
            const votingSection = document.getElementById("voting-section");
            votingSection.innerHTML = "<h4>Vote if punishments are unfair</h4>";
        
            const punishmentsSnapshot = await db.collection("punishmentAssignments").get();
            punishmentsSnapshot.forEach(doc => {
                const assignment = doc.data();
                const punishmentDiv = document.createElement("div");
                
                if (assignment.punishment) {
                    punishmentDiv.innerHTML = `
                        <p><strong>${assignment.assignedUser}:</strong> ${assignment.punishment}</p>
                        <input type="checkbox" onclick="voteUnfair('${doc.id}')"> Unfair
                    `;
                } else {
                    punishmentDiv.innerHTML = `<p><strong>${assignment.assignedUser}:</strong> Not set</p>`;
                }
        
                votingSection.appendChild(punishmentDiv);
            });
        }
        async function submitAdminData() {
            const userInputs = document.querySelectorAll("#user-container .item-container");
            for (let input of userInputs) {
                const id = input.getAttribute("data-id");
                const name = input.children[0].value.trim();
                const password = input.children[1].value.trim();

                if (name && password) {
                    if (id) {
                        await db.collection("users").doc(id).set({ name, password });
                    } else {
                        await db.collection("users").add({ name, password });
                    }
                }
            }

            const goalInputs = document.querySelectorAll("#goal-container .item-container");
            for (let input of goalInputs) {
                const id = input.getAttribute("data-id");
                const text = input.children[0].value.trim();

                if (text) {
                    if (id) {
                        await db.collection("goals").doc(id).set({ text });
                    } else {
                        await db.collection("goals").add({ text });
                    }
                }
            }

            alert("Data submitted successfully.");
        }

        // Load punishment assignment for the week
        async function loadPunishmentAssignment() {
            const assignedUserElem = document.getElementById("assigned-user");
            const assignedPunishmentElem = document.getElementById("assigned-punishment");
    
            const assignmentDoc = await db.collection("punishmentAssignments").doc(currentUser).get();
            if (assignmentDoc.exists) {
                const assignment = assignmentDoc.data();
                assignedUserElem.textContent = assignment.assignedUser || "No user assigned";
                assignedPunishmentElem.textContent = assignment.punishment || "Not assigned yet.";
    
                // Ensure punishment-section is displayed if assignment data exists
                document.getElementById("punishment-section").style.display = "block";
            } else {
                console.log("No punishment assignment found for current user.");
            }
        }

        // Load weekly report data
        async function loadWeeklyReport() {
            const reportSnapshot = await db.collection("weeklyReports")
                .where("userId", "==", currentUser)
                .orderBy("timestamp", "desc")
                .limit(1)
                .get();

            if (!reportSnapshot.empty) {
                const reportData = reportSnapshot.docs[0].data();
                document.getElementById("time-since-fail").textContent = new Date(reportData.timestamp.toDate()).toLocaleString();
                
                const failCountSnapshot = await db.collection("weeklyReports").where("userId", "==", currentUser).get();
                document.getElementById("fail-count").textContent = failCountSnapshot.size;
            } else {
                document.getElementById("time-since-fail").textContent = "N/A";
                document.getElementById("fail-count").textContent = "0";
            }
        }

        // Submit punishment for assigned user
        async function submitPunishment() {
            const punishmentText = document.getElementById("punishment-text").value.trim();
            if (!punishmentText) {
                alert("Punishment text is required.");
                return;
            }
    
            const assignmentDoc = await db.collection("punishmentAssignments").doc(currentUser).get();
            if (assignmentDoc.exists) {
                const assignedUser = assignmentDoc.data().assignedUserId;
                await db.collection("punishmentAssignments").doc(assignedUser).update({
                    punishment: punishmentText
                });
                alert("Punishment submitted.");
                loadPunishmentAssignment();
            } else {
                console.log("No punishment assignment document exists for the current user.");
                alert("No punishment assignment available for submission.");
            }
        }

        // Submit weekly goal report
        async function submitGoalReport() {
            const failed = document.getElementById("failed-goal").checked;
            await db.collection("weeklyReports").add({
                userId: currentUser,
                failed,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Report submitted.");
        }

        // Change user password
        async function changePassword() {
            const newPassword = document.getElementById("new-password").value.trim();
            if (newPassword) {
                await db.collection("users").doc(currentUser).update({ password: newPassword });
                alert("Password changed successfully.");
            } else {
                alert("New password cannot be empty.");
            }
        }

        // Cast vote for punishment fairness
        async function voteUnfair(assignmentId) {
            await db.collection("punishmentVotes").add({
                assignmentId,
                userId: currentUser,
                vote: "unfair"
            });
        
            const votesSnapshot = await db.collection("punishmentVotes").where("assignmentId", "==", assignmentId).get();
            const totalVotes = votesSnapshot.size;
            const usersCount = (await db.collection("users").get()).size;
        
            if (totalVotes > usersCount / 2) {
                await db.collection("punishmentAssignments").doc(assignmentId).update({
                    punishment: ""
                });
                alert("Punishment was deemed unfair and has been removed. A new punishment must be set.");
            } else {
                alert("Vote submitted.");
            }
        }

        // Admin function to clear this week's fails
        async function resetWeeklyFails() {
            const failsSnapshot = await db.collection("weeklyReports").get();
            failsSnapshot.forEach(async (doc) => {
                await db.collection("weeklyReports").doc(doc.id).delete();
            });
            alert("Weekly fails cleared.");
        }

        async function randomizePunishmentAssignments() {
            const usersSnapshot = await db.collection("users").get();
            const users = usersSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            let shuffledUsers;
    
            do {
                shuffledUsers = users.slice().sort(() => Math.random() - 0.5);
            } while (shuffledUsers.some((user, i) => user.id === users[i].id));
    
            for (let i = 0; i < users.length; i++) {
                const assignedUser = shuffledUsers[(i + 1) % users.length];
                await db.collection("punishmentAssignments").doc(users[i].id).set({
                    assignedUser: assignedUser.name,
                    punishment: ""
                });
            }
            alert("Punishment assignments randomized.");
            loadAdminData();
        }


        // Load admin data (users and goals) for editing
        async function loadAdminData() {
            const userContainer = document.getElementById("user-container");
            userContainer.innerHTML = "";
            const userSnapshot = await db.collection("users").get();
            userSnapshot.forEach(doc => {
                addUserInput(doc.id, doc.data().name, doc.data().password);
            });

            const goalContainer = document.getElementById("goal-container");
            goalContainer.innerHTML = "";
            const goalSnapshot = await db.collection("goals").get();
            goalSnapshot.forEach(doc => {
                addGoalInput(doc.id, doc.data().text);
            });
        }

        function addUserInput(id = "", name = "", password = "") {
            const userContainer = document.getElementById("user-container");
            const div = document.createElement("div");
            div.classList.add("item-container");
            div.setAttribute("data-id", id);
            div.innerHTML = `
                <input type="text" placeholder="Username" value="${name}">
                <input type="password" placeholder="Password" value="${password}">
                <button onclick="removeUser('${id}', this)">Remove</button>
            `;
            userContainer.appendChild(div);
        }

        async function removeUser(id, elem) {
            if (id) await db.collection("users").doc(id).delete();
            elem.parentElement.remove();
        }

        async function removeGoal(id, elem) {
            if (id) await db.collection("goals").doc(id).delete();
            elem.parentElement.remove();
        }

        function addGoalInput(id = "", text = "") {
            const goalContainer = document.getElementById("goal-container");
            const div = document.createElement("div");
            div.classList.add("item-container");
            div.setAttribute("data-id", id);
            div.innerHTML = `
                <input type="text" placeholder="Goal" value="${text}">
                <button onclick="removeGoal('${id}', this)">Remove</button>
            `;
            goalContainer.appendChild(div);
        }
    </script>
</body>
</html>
