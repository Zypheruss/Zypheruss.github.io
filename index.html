<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Goal Reporting with Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #goal-form, #password-section { margin-top: 20px; }
        #reporting-section { display: none; }
        .goal-status { margin: 10px; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .fail { color: red; }
    </style>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <h1>Anonymous Goal Reporting</h1>

    <!-- Password Section -->
    <div id="password-section">
        <p>Enter the passcode to report:</p>
        <input type="password" id="password" placeholder="Passcode">
        <button onclick="checkPassword()">Submit</button>
    </div>

    <!-- Reporting Section -->
    <div id="reporting-section">
        <h2>Weekly Goals</h2>
        <div id="goals">
            <div class="goal-status" id="goal1-status">Goal 1: Workout 3 times a week</div>
            <div class="goal-status" id="goal2-status">Goal 2: No sugary snacks</div>
        </div>
        
        <!-- Reporting Form -->
        <div id="goal-form">
            <p>Report if you failed any goals this week (anonymous):</p>
            <input type="checkbox" id="missed-goal1"> Missed Goal 1<br>
            <input type="checkbox" id="missed-goal2"> Missed Goal 2<br>
            <button onclick="submitReport()">Submit Report</button>
        </div>

        <!-- Status Display -->
        <h3>This Week's Reports</h3>
        <div id="status-display"></div>
    </div>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCXH3CI4YN4fRDH1Wcp_PQQCGBvpp8Dep8",
            authDomain: "goal-storing.firebaseapp.com",
            projectId: "goal-storing",
            storageBucket: "goal-storing.appspot.com",
            messagingSenderId: "1041018123354",
            appId: "1:1041018123354:web:497f0baf04deb124ccd463",
            measurementId: "G-1FPM1DV7KH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Check if the password is correct, then load data
        async function checkPassword() {
            const inputPass = document.getElementById("password").value.trim();
            const passcodeDoc = await db.collection("settings").doc("config").get();
            const storedPasscode = passcodeDoc.data()?.passcode;

            if (inputPass === storedPasscode) {
                console.log("Passcode correct.");
                document.getElementById("password-section").style.display = "none";
                document.getElementById("reporting-section").style.display = "block";
                loadReports();
            } else {
                console.log("Passcode incorrect.");
                alert("Incorrect passcode.");
            }
        }

        // Function to load reports from Firestore
        async function loadReports() {
            const statusDisplay = document.getElementById("status-display");
            statusDisplay.innerHTML = "";

            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const snapshot = await db.collection("weeklyReports").where("timestamp", ">=", startOfWeek).get();

            let goal1Failures = 0;
            let goal2Failures = 0;
            let lastGoal1Failure = null;
            let lastGoal2Failure = null;

            snapshot.forEach(doc => {
                const report = doc.data();
                if (report.goal1) {
                    goal1Failures++;
                    lastGoal1Failure = report.timestamp;
                }
                if (report.goal2) {
                    goal2Failures++;
                    lastGoal2Failure = report.timestamp;
                }
            });

            const goal1Status = document.getElementById("goal1-status");
            const goal2Status = document.getElementById("goal2-status");

            goal1Status.innerHTML = `Goal 1: Workout 3 times a week<br>
                                     Failures this week: ${goal1Failures}<br>
                                     Last failed: ${lastGoal1Failure ? new Date(lastGoal1Failure.toDate()).toLocaleString() : "N/A"}`;

            goal2Status.innerHTML = `Goal 2: No sugary snacks<br>
                                     Failures this week: ${goal2Failures}<br>
                                     Last failed: ${lastGoal2Failure ? new Date(lastGoal2Failure.toDate()).toLocaleString() : "N/A"}`;
        }

        // Function to submit report to Firestore
        async function submitReport() {
            const missedGoal1 = document.getElementById("missed-goal1").checked;
            const missedGoal2 = document.getElementById("missed-goal2").checked;

            await db.collection("weeklyReports").add({
                goal1: missedGoal1,
                goal2: missedGoal2,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("Report submitted anonymously.");
            loadReports(); // Refresh display
        }
    </script>
</body>
</html>
