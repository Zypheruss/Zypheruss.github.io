<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Goal Reporting with Firebase</title>
    <style>
        /* Previous styles remain the same */
        body { font-family: Arial, sans-serif; text-align: center; }
        #goal-form, #password-section, #punishment-section, #admin-section { margin-top: 20px; }
        #reporting-section, #punishment-section, #admin-section { display: none; }
        .goal-status, .punishment-status { margin: 10px; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .fail { color: red; }
        .item-container { margin-bottom: 15px; }
        .item-container input { margin-right: 10px; }
        .punishment-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .punishment-table th,
        .punishment-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .punishment-table th {
            background-color: #f4f4f4;
        }
        
        .goal-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .submit-votes-btn {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .submit-votes-btn:hover {
            background-color: #45a049;
        }

        /* New styles for failed goals list */
        #failed-goals-list {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .failed-goal-item {
            text-align: left;
            padding: 5px;
            margin: 5px 0;
            background-color: #f9f9f9;
        }
    </style>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <!-- Previous HTML sections remain the same until the goal-form section -->
    
    <!-- Password Section -->
    <div id="password-section">
        <p>Enter your unique passcode:</p>
        <input type="password" id="password" placeholder="Passcode">
        <button onclick="checkPassword()">Submit</button>
    </div>

    <!-- Reporting Section -->
    <div id="reporting-section">
        <h2>Anonymous Goal Reporting</h2>
        <h3>Current Goals</h3>
        <div id="goals-list"></div>

        <!-- Reporting Form -->
        <div id="goal-form">
            <p>Did you fail any goals this week?</p>
            <button onclick="submitGoalReport()">Submit Report</button>
        </div>

        <h3>This Week's Failed Goals</h3>
        <div id="failed-goals-list"></div>

        <h3>This Week's Report</h3>
        <div id="status-display">
            <p><strong>Time since last failed:</strong> <span id="time-since-fail">N/A</span></p>
            <p><strong>Amount of times failed this week:</strong> <span id="fail-count">0</span></p>
        </div>

        <!-- Punishment Section -->
        <div id="punishment-section">
            <h3>Weekly Punishment Assignment</h3>
            <div id="punishment-info">
                <p><strong>Your Assigned User:</strong> <span id="assigned-user"></span></p>
                <p><strong>Your Assigned Punishment:</strong> <span id="assigned-punishment"></span></p>
            </div>
            <div id="punishment-form">
                <textarea id="punishment-text" placeholder="Enter punishment..."></textarea><br>
                <button onclick="submitPunishment()">Submit Punishment</button>
            </div>
            <div id="voting-section">
                <h3>Vote on Unfair Punishments</h3>
                <div id="punishment-votes"></div>
            </div>
        </div>

        <!-- Change Password Section -->
        <div id="change-password-section">
            <h3>Change Password</h3>
            <input type="password" id="new-password" placeholder="New Password">
            <button onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section">
        <h2>Admin: Manage Users and Goals</h2>

        <!-- User Management -->
        <div>
            <h3>Users</h3>
            <div id="user-container"></div>
            <button onclick="addUserInput()">Add User</button>
            <button onclick="resetWeeklyFails()">Clear This Week's Fails</button>
            <button onclick="randomizePunishmentAssignments()">Randomize Punishment Assignments</button>
        </div>

        <!-- Goal Management -->
        <div>
            <h3>Goals</h3>
            <div id="goal-container"></div>
            <button onclick="addGoalInput()">Add Goal</button>
        </div>

        <button onclick="submitAdminData()">Submit Data</button>
    </div>

    <script>
        // Firebase configuration remains the same
        const firebaseConfig = {
            apiKey: "AIzaSyCXH3CI4YN4fRDH1Wcp_PQQCGBvpp8Dep8",
            authDomain: "goal-storing.firebaseapp.com",
            projectId: "goal-storing",
            storageBucket: "goal-storing.appspot.com",
            messagingSenderId: "1041018123354",
            appId: "1:1041018123354:web:497f0baf04deb124ccd463",
            measurementId: "G-1FPM1DV7KH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const adminCode = "admincode";
        let currentUser;

        // Previous functions remain the same until loadGoals

        // Modified loadGoals function to show global and personal goals
        async function loadGoals() {
            const goalsList = document.getElementById("goals-list");
            goalsList.innerHTML = "<h4>Your Goals:</h4>";
            
            try {
                // Get global goals
                const globalGoalsSnapshot = await db.collection("goals")
                    .where("isGlobal", "==", true)
                    .get();
                
                // Get user-specific goals
                const personalGoalsSnapshot = await db.collection("goals")
                    .where("userId", "==", currentUser)
                    .get();
                
                // Combine and display all applicable goals
                [...globalGoalsSnapshot.docs, ...personalGoalsSnapshot.docs].forEach((doc) => {
                    const goal = doc.data();
                    const goalDiv = document.createElement("div");
                    goalDiv.classList.add("goal-item");
                    goalDiv.innerHTML = `
                        <input type="checkbox" id="goal-${doc.id}" class="goal-checkbox">
                        <label for="goal-${doc.id}">${goal.text} ${goal.isGlobal ? '(Global)' : '(Personal)'}</label>
                    `;
                    goalsList.appendChild(goalDiv);
                });
            } catch (error) {
                console.error("Error loading goals:", error);
                alert("Error loading goals. Please try again.");
            }
        }

        // New function to load failed goals for the week
        async function loadFailedGoals() {
            const failedGoalsList = document.getElementById("failed-goals-list");
            failedGoalsList.innerHTML = "";
            
            try {
                const weekStart = new Date();
                weekStart.setHours(0, 0, 0, 0);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());

                const reportsSnapshot = await db.collection("weeklyReports")
                    .where("timestamp", ">=", weekStart)
                    .get();

                const failedGoals = {};
                
                for (const doc of reportsSnapshot.docs) {
                    const report = doc.data();
                    for (const goalId of report.failedGoals) {
                        if (!failedGoals[goalId]) {
                            failedGoals[goalId] = 1;
                        } else {
                            failedGoals[goalId]++;
                        }
                    }
                }

                for (const [goalId, count] of Object.entries(failedGoals)) {
                    const goalDoc = await db.collection("goals").doc(goalId).get();
                    if (goalDoc.exists) {
                        const goalData = goalDoc.data();
                        const div = document.createElement("div");
                        div.classList.add("failed-goal-item");
                        div.textContent = `${goalData.text}: Failed ${count} times`;
                        failedGoalsList.appendChild(div);
                    }
                }
            } catch (error) {
                console.error("Error loading failed goals:", error);
            }
        }

        // Modified addGoalInput function to include global/personal selection
        function addGoalInput(id = "", text = "", userId = "", isGlobal = false) {
            const goalContainer = document.getElementById("goal-container");
            const div = document.createElement("div");
            div.classList.add("item-container");
            div.setAttribute("data-id", id);
            div.innerHTML = `
                <input type="text" placeholder="Goal" value="${text}">
                <select class="goal-type">
                    <option value="global" ${isGlobal ? 'selected' : ''}>Global Goal</option>
                    <option value="personal" ${!isGlobal ? 'selected' : ''}>Personal Goal</option>
                </select>
                <select class="user-select" ${isGlobal ? 'disabled' : ''}>
                    <option value="">Select User</option>
                </select>
                <button onclick="removeGoal('${id}', this)">Remove</button>
            `;
            
            // Add event listener for goal type change
            const goalTypeSelect = div.querySelector('.goal-type');
            const userSelect = div.querySelector('.user-select');
            
            goalTypeSelect.addEventListener('change', function() {
                userSelect.disabled = this.value === 'global';
            });
            
            // Populate user select if not global
            if (!isGlobal) {
                loadUserOptions(userSelect, userId);
            }
            
            goalContainer.appendChild(div);
        }

        // Modified submitAdminData to handle global/personal goals
        async function submitAdminData() {
            try {
                // Handle users
                const userInputs = document.querySelectorAll("#user-container .item-container");
                for (let input of userInputs) {
                    const id = input.getAttribute("data-id");
                    const name = input.children[0].value.trim();
                    const password = input.children[1].value.trim();

                    if (name && password) {
                        if (id) {
                            await db.collection("users").doc(id).set({ name, password });
                        } else {
                            await db.collection("users").add({ name, password });
                        }
                    }
                }

                // Handle goals
                const goalInputs = document.querySelectorAll("#goal-container .item-container");
                for (let input of goalInputs) {
                    const id = input.getAttribute("data-id");
                    const text = input.children[0].value.trim();
                    const isGlobal = input.querySelector('.goal-type').value === 'global';
                    const userId = isGlobal ? null : input.querySelector('.user-select').value;

                    if (text) {
                        const goalData = {
                            text,
                            isGlobal,
                            userId: isGlobal ? null : userId
                        };

                        if (id) {
                            await db.collection("goals").doc(id).set(goalData);
                        } else {
                            await db.collection("goals").add(goalData);
                        }
                    }
                }

                alert("Data submitted successfully.");
            } catch (error) {
                console.error("Error submitting data:", error);
                alert("Error submitting data. Please try again.");
            }
        }

        // Modified checkPassword to also load failed goals and punishment votes
        async function checkPassword() {
            const inputPass = document.getElementById("password").value.trim();
            if (inputPass === adminCode) {
                document.getElementById("password-section").style.display = "none";
                document.getElementById("admin-section").style.display = "block";
                loadAdminData();
            } else {
                const userDoc = await db.collection("users").where("password", "==", inputPass).get();
                if (!userDoc.empty) {
                    currentUser = userDoc.docs[0].id;
                    document.getElementById("password-section").style.display = "none";
                    document.getElementById("reporting-section").style.display = "block";
                    loadGoals();
                    loadFailedGoals();
                    loadPunishmentAssignment();
                    loadWeeklyReport();
                    loadPunishmentVotes();
                } else {
                    alert("Incorrect passcode.");
                }
            }
        }

        // Modified submitGoalReport to also refresh failed goals list
        async function submitGoalReport() {
            const failedGoals = [];
            document.querySelectorAll('.goal-checkbox:checked').forEach(checkbox => {
                failedGoals.push(checkbox.id.replace('goal-', ''));
            });
        
            try {
                await db.collection("weeklyReports").add({
                    userId: currentUser,
                    failedGoals: failedGoals,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Report submitted successfully.");
                loadWeeklyReport();
                loadFailedGoals();
            } catch (error) {
                console.error("Error submitting report:", error);
                alert("Error submitting report. Please try again.");
            }
        }
        async function submitUnfairVotes() {
            try {
                const checkboxes = document.querySelectorAll('.unfair-vote:checked:not([disabled])');
                const batch = db.batch();
                
                for (const checkbox of checkboxes) {
                    const assignmentId = checkbox.dataset.assignmentId;
                    
                    // Add vote
                    const voteRef = db.collection("punishmentVotes").doc();
                    batch.set(voteRef, {
                        assignmentId,
                        userId: currentUser,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Check if majority reached
                    const votesSnapshot = await db.collection("punishmentVotes")
                        .where("assignmentId", "==", assignmentId)
                        .get();
                    
                    const usersSnapshot = await db.collection("users").get();
                    const totalUsers = usersSnapshot.size;
                    
                    if (votesSnapshot.size + 1 > totalUsers / 2) {
                        // Majority reached, reset punishment
                        const assignmentRef = db.collection("punishmentAssignments").doc(assignmentId);
                        batch.update(assignmentRef, {
                            punishment: "",
                            votes: 0
                        });
                    }
                }
        
                await batch.commit();
                alert("Votes submitted successfully.");
                loadPunishmentVotes();
                
            } catch (error) {
                console.error("Error submitting votes:", error);
                alert("Error submitting votes. Please try again.");
            }
        }

        // Change user password
        async function changePassword() {
            const newPassword = document.getElementById("new-password").value.trim();
            if (newPassword) {
                await db.collection("users").doc(currentUser).update({ password: newPassword });
                alert("Password changed successfully.");
            } else {
                alert("New password cannot be empty.");
            }
        }

        // Cast vote for punishment fairness
        async function voteUnfair(assignmentId) {
            await db.collection("punishmentVotes").add({
                assignmentId,
                userId: currentUser,
                vote: "unfair"
            });
        
            const votesSnapshot = await db.collection("punishmentVotes").where("assignmentId", "==", assignmentId).get();
            const totalVotes = votesSnapshot.size;
            const usersCount = (await db.collection("users").get()).size;
        
            if (totalVotes > usersCount / 2) {
                await db.collection("punishmentAssignments").doc(assignmentId).update({
                    punishment: ""
                });
                alert("Punishment was deemed unfair and has been removed. A new punishment must be set.");
            } else {
                alert("Vote submitted.");
            }
        }

        // Admin function to clear this week's fails
        async function resetWeeklyFails() {
            const failsSnapshot = await db.collection("weeklyReports").get();
            failsSnapshot.forEach(async (doc) => {
                await db.collection("weeklyReports").doc(doc.id).delete();
            });
            alert("Weekly fails cleared.");
        }

        async function randomizePunishmentAssignments() {
            try {
                const usersSnapshot = await db.collection("users").get();
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                
                if (users.length < 2) {
                    alert("Need at least 2 users to assign punishments.");
                    return;
                }
        
                // Create assignments ensuring no self-assignments
                const assignments = [];
                const available = [...users];
                
                for (const user of users) {
                    const validTargets = available.filter(target => target.id !== user.id);
                    if (validTargets.length === 0) {
                        // If we reach a point where only self-assignment is possible,
                        // we need to shuffle and start over
                        return randomizePunishmentAssignments();
                    }
                    
                    const randomIndex = Math.floor(Math.random() * validTargets.length);
                    const target = validTargets[randomIndex];
                    assignments.push({ assigner: user, target });
                    
                    // Remove the assigned target from available users
                    const targetIndex = available.findIndex(u => u.id === target.id);
                    available.splice(targetIndex, 1);
                }
        
                // Save assignments to Firebase
                const batch = db.batch();
                for (const assignment of assignments) {
                    const docRef = db.collection("punishmentAssignments").doc(assignment.assigner.id);
                    batch.set(docRef, {
                        assignedUser: assignment.target.name,
                        assignedUserId: assignment.target.id,
                        punishment: "",
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        votes: 0
                    });
                }
        
                await batch.commit();
                alert("Punishment assignments randomized successfully.");
                loadAdminData();
                
            } catch (error) {
                console.error("Error randomizing assignments:", error);
                alert("Error randomizing assignments. Please try again.");
            }
        }
        
        // Load admin data (users and goals) for editing
        async function loadAdminData() {
            const userContainer = document.getElementById("user-container");
            userContainer.innerHTML = "";
            const userSnapshot = await db.collection("users").get();
            userSnapshot.forEach(doc => {
                addUserInput(doc.id, doc.data().name, doc.data().password);
            });

            const goalContainer = document.getElementById("goal-container");
            goalContainer.innerHTML = "";
            const goalSnapshot = await db.collection("goals").get();
            goalSnapshot.forEach(doc => {
                addGoalInput(doc.id, doc.data().text);
            });
        }

        function addUserInput(id = "", name = "", password = "") {
            const userContainer = document.getElementById("user-container");
            const div = document.createElement("div");
            div.classList.add("item-container");
            div.setAttribute("data-id", id);
            div.innerHTML = `
                <input type="text" placeholder="Username" value="${name}">
                <input type="password" placeholder="Password" value="${password}">
                <button onclick="removeUser('${id}', this)">Remove</button>
            `;
            userContainer.appendChild(div);
        }

        async function removeUser(id, elem) {
            if (id) await db.collection("users").doc(id).delete();
            elem.parentElement.remove();
        }

        async function removeGoal(id, elem) {
            if (id) await db.collection("goals").doc(id).delete();
            elem.parentElement.remove();
        }

        function addGoalInput(id = "", text = "", userId = "") {
            const goalContainer = document.getElementById("goal-container");
            const div = document.createElement("div");
            div.classList.add("item-container");
            div.setAttribute("data-id", id);
            div.innerHTML = `
                <input type="text" placeholder="Goal" value="${text}">
                <select class="user-select">
                    <option value="">Select User</option>
                </select>
                <button onclick="removeGoal('${id}', this)">Remove</button>
            `;
            
            // Populate user select
            const select = div.querySelector('.user-select');
            loadUserOptions(select, userId);
            
            goalContainer.appendChild(div);
        }
        async function loadUserOptions(select, selectedUserId = "") {
            try {
                const usersSnapshot = await db.collection("users").get();
                usersSnapshot.forEach(doc => {
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.text = doc.data().name;
                    option.selected = doc.id === selectedUserId;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading users:", error);
            }
        }
        
    </script>
</body>
</html>
